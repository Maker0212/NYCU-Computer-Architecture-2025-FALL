//=========================================================================
// riscv-custom.S
//=========================================================================
// Simple custom test for processor verification

#include "riscv-macros.h"

  TEST_RISCV_BEGIN

  //==================================================================
  // Test 1: WAW Hazard Detection (同週期寫入相同暫存器)
  //==================================================================
  // 兩個 addi 指令寫入同一個目標暫存器 (x5)
  // Scoreboard 應該偵測到 WAW hazard 並延遲第二條指令發射
  addi x10, x0, 10    // x10 = 10
  addi x5, x10, 5     // x5 = 10 + 5 = 15  (第一次寫入 x5)
  addi x5, x10, 20    // x5 = 10 + 20 = 30 (第二次寫入 x5, WAW hazard)
  nop
  nop
  addi x11, x0, 30    // x11 = 30
  bne x5, x11, _fail  // 檢查最終 x5 應該是 30

  //==================================================================
  // Test 2: Dual Issue - 獨立非 ALU 指令
  //==================================================================
  // 使用兩個獨立的非 ALU 指令 (lui 和 auipc)
  // 當無相依性時，處理器應該能夠在同週期雙發射
  lui x12, 0x12345    // x12 = 0x12345000
  auipc x13, 0x100    // x13 = PC + 0x100000
  
  // 驗證 lui 結果
  li x14, 0x12345000
  bne x12, x14, _fail

  //==================================================================
  // Test 3: ALU Operations with Dependencies
  //==================================================================
  // 測試 ALU 指令之間的相依性處理
  li x15, 10
  li x16, 20
  add x17, x15, x16   // x17 = 30
  sub x18, x17, x15   // x18 = 30 - 10 = 20 (RAW dependency on x17)
  li x19, 20
  bne x18, x19, _fail

  //==================================================================
  // Test 4: Independent ALU Operations
  //==================================================================
  // 兩個完全獨立的 ALU 操作，應該可以雙發射
  li x20, 5
  li x21, 8
  li x22, 3
  li x23, 7
  add x24, x20, x21   // x24 = 5 + 8 = 13 (獨立)
  sub x25, x23, x22   // x25 = 7 - 3 = 4  (獨立)
  
  // 驗證結果
  li x26, 13
  bne x24, x26, _fail
  li x27, 4
  bne x25, x27, _fail

  //==================================================================
  // Test 5: WAW Hazard with ALU Operations
  //==================================================================
  // 測試 ALU 操作的 WAW hazard
  li x10, 100
  li x11, 50
  add x6, x10, x11    // x6 = 150
  sub x6, x10, x11    // x6 = 50 (WAW on x6, 應該等第一條完成)
  li x28, 50
  bne x6, x28, _fail

  //==================================================================
  // Test 6: Pass - All tests completed
  //==================================================================
  j _pass

  TEST_RISCV_END
